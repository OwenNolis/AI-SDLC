name: Dependabot automation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'

    steps:
      - name: Install jq + python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          python -m pip install --upgrade pip requests

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@d7267f607e9d3fb96fc2fbe83e0af444713e90b7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: AI review (Gemini) -> decision (non-blocking)
        id: ai_review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          BASE_REF: ${{ github.base_ref }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          python - <<'PY'
          import os, json, subprocess, textwrap
          import requests

          def run(cmd):
            return subprocess.check_output(cmd, text=True).strip()

          pr_url   = os.environ["PR_URL"]
          title    = os.environ.get("PR_TITLE","")
          body     = os.environ.get("PR_BODY","") or ""
          base_ref = os.environ.get("BASE_REF","")
          head_sha = os.environ.get("HEAD_SHA","")

          model = os.environ.get("GEMINI_MODEL") or "models/gemini-2.5-flash-lite"
          api_key = os.environ.get("GEMINI_API_KEY","")

          # Diff summary via GitHub API (via gh)
          diff_summary = ""
          try:
            repo = os.environ["GITHUB_REPOSITORY"]
            diff_summary = run([
              "gh","api","-H","Accept: application/vnd.github+json",
              f"/repos/{repo}/compare/{base_ref}...{head_sha}",
              "--jq", '.files[] | "\\(.filename) (+\\(.additions)/-\\(.deletions))"'
            ])
            diff_summary = "\n".join(diff_summary.splitlines()[:40])
          except Exception:
            diff_summary = "(diff summary unavailable)"

          prompt = """You are a senior backend/frontend engineer reviewing a Dependabot dependency update PR.

          Write a short structured review in Markdown with these sections:

          1) Summary
          2) Risk assessment (LOW / MEDIUM / HIGH)
          3) Breaking-change suspicion (YES/NO + why)
          4) Verification steps (what to run)
          5) Final recommendation: APPROVE or HOLD

          Be strict. If unsure: HOLD.
          """

          # Build request body for Gemini
          text = (
            prompt.strip()
            + "\n\nContext:\n"
            + f"Title: {title}\n\n"
            + "PR body:\n" + body + "\n\n"
            + "Diff summary:\n" + diff_summary + "\n"
          )

          decision = "HOLD"
          review_text = "AI review skipped. Final recommendation: HOLD"

          if not api_key:
            review_text = "GEMINI_API_KEY missing. Final recommendation: HOLD"
          else:
            url = f"https://generativelanguage.googleapis.com/v1beta/{model}:generateContent"
            payload = {
              "contents": [{"parts": [{"text": text}]}]
            }
            headers = {
              "Content-Type": "application/json",
              "x-goog-api-key": api_key
            }

            try:
              r = requests.post(url, headers=headers, data=json.dumps(payload), timeout=25)
              if r.status_code != 200:
                # Non-blocking: HOLD + comment, but do not fail
                review_text = f"Gemini API error (HTTP {r.status_code}). Final recommendation: HOLD\n\nResponse: {r.text[:800]}"
              else:
                data = r.json()
                review_text = (
                  data.get("candidates", [{}])[0]
                    .get("content", {})
                    .get("parts", [{}])[0]
                    .get("text", "")
                ).strip() or "AI review empty. Final recommendation: HOLD"

                # Decision parse
                decision = "APPROVE"
                low = review_text.lower()
                if "final recommendation: hold" in low or "\nhold" in low or " hold" in low:
                  decision = "HOLD"

            except Exception as e:
              review_text = f"Gemini call failed ({e}). Final recommendation: HOLD"

          # Write outputs for next steps
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"decision={decision}\n")

          # Comment on PR (always, but don't fail if comment fails)
          md = "## ðŸ¤– AI Review (Gemini)\n\n" + review_text + f"\n\n**Decision:** `{decision}`\n"
          open("ai-review.md","w",encoding="utf-8").write(md)

          try:
            subprocess.check_call(["gh","pr","comment", pr_url, "--body-file","ai-review.md"])
          except Exception:
            pass
          PY

      - name: Auto-approve (only if AI APPROVE)
        if: steps.ai_review.outputs.decision == 'APPROVE'
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr review --approve "$PR_URL" || true

      - name: Check CI status checks are green (required for auto-merge)
        id: ci_green
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          STATES="$(gh pr view "$PR_URL" --json statusCheckRollup --jq '.statusCheckRollup[].state' || true)"

          if [ -z "$STATES" ]; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "No status checks found yet."
            exit 0
          fi

          echo "States:"
          echo "$STATES" | sort -u

          if echo "$STATES" | grep -qv '^SUCCESS$'; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "âŒ CI is not fully green yet."
          else
            echo "ok=true" >> "$GITHUB_OUTPUT"
            echo "âœ… CI is green (all checks SUCCESS)."
          fi

      - name: Enable auto-merge (PATCH only, CI green, and NO AI HOLD)
        if: >
          steps.ai_review.outputs.decision == 'APPROVE' &&
          steps.ci_green.outputs.ok == 'true' &&
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr merge --auto --merge "$PR_URL" || true

      - name: Safety note (when HOLD)
        if: steps.ai_review.outputs.decision == 'HOLD'
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr comment "$PR_URL" --body "ðŸ›‘ **AI decision = HOLD** â†’ auto-merge is disabled for this PR (even if it's a patch)." || true